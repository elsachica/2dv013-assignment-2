---
- name: Deploy k3s cluster
  hosts: all
  become: yes
  gather_facts: no
  vars:
    ansible_python_interpreter: /usr/bin/python3

  pre_tasks:
    - name: Wait for SSH connection
      wait_for_connection:
        timeout: 300

    - name: Gather facts
      setup:

  tasks:
    - name: Install k3s
      shell: curl -sfL https://get.k3s.io | sh -s - server --write-kubeconfig-mode 644 --tls-san {{ ansible_host }}
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for k3s to be active
      systemd:
        name: k3s
        state: started
      register: k3s_service
      until: k3s_service.status.ActiveState == "active"
      retries: 30
      delay: 10

    - name: Wait for kubectl to be available
      command: kubectl get nodes
      register: kubectl_check
      until: kubectl_check.rc == 0
      retries: 30
      delay: 5

    - name: Wait for node to be Ready
      command: kubectl get nodes --no-headers
      register: node_status
      until: "'Ready' in node_status.stdout"
      retries: 30
      delay: 10

    - name: Install Helm
      get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        dest: /tmp/get_helm.sh
        mode: '0755'

    - name: Run Helm installation
      command: /tmp/get_helm.sh

    - name: Copy kubeconfig to ubuntu home for easy access
      copy:
        src: /etc/rancher/k3s/k3s.yaml
        dest: /home/ubuntu/kubeconfig.yaml
        owner: ubuntu
        group: ubuntu
        mode: '0644'
        remote_src: yes

    - name: Fetch server CA certificate
      become: yes
      slurp:
        src: /var/lib/rancher/k3s/server/tls/server-ca.crt
      register: server_ca_cert

    - name: Fetch client admin certificate
      become: yes
      slurp:
        src: /var/lib/rancher/k3s/server/tls/client-admin.crt
      register: client_admin_cert

    - name: Fetch client admin key
      become: yes
      slurp:
        src: /var/lib/rancher/k3s/server/tls/client-admin.key
      register: client_admin_key

    - name: Generate external kubeconfig file
      copy:
        content: |
          apiVersion: v1
          kind: Config
          clusters:
          - cluster:
              certificate-authority-data: "{{ server_ca_cert.content }}"
              server: https://{{ ansible_host }}:6443
            name: k3s
          contexts:
          - context:
              cluster: k3s
              user: admin
            name: k3s
          current-context: k3s
          users:
          - name: admin
            user:
              client-certificate-data: "{{ client_admin_cert.content }}"
              client-key-data: "{{ client_admin_key.content }}"
        dest: /home/ubuntu/kubeconfig-external.yaml
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Display deployment summary
      debug:
        msg: |
          k3s cluster is ready!
          Cluster Info:
          External IP: {{ ansible_host }}