services:
  mongodb:
    image: mongo:8.0.0

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  # NY SERVICE: RabbitMQ
  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672" 
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=password
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq

  just-task-it:
    build:
      context: .
    image: 2dv013/just-task-it:1.0.0
    depends_on:
      - mongodb
      - redis
      - rabbitmq
    restart: on-failure
    environment:
      - BASE_URL=${BASE_URL:-/}
      - DB_CONNECTION_STRING=${DB_CONNECTION_STRING:-mongodb://mongodb:27017/just-task-it}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - RABBITMQ_URL=${RABBITMQ_URL:-amqp://admin:password@rabbitmq:5672}  # ‚Üê NY
      - PORT=${EXPRESS_APP_PORT:-3000}
      - SESSION_NAME=${SESSION_NAME:-just-task-it-feat-logging.user-session}
      - SESSION_SECRET=${SESSION_SECRET}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOGGER_MORGAN_FORMAT_ADD_REMOTE=${LOGGER_MORGAN_FORMAT_ADD_REMOTE:-true}
      - LOGGER_COMBINED_LOG_FILE=${LOGGER_COMBINED_LOG_FILE:-/var/log/just-task-it/combined.log}
      - LOGGER_ERROR_LOG_FILE=${LOGGER_ERROR_LOG_FILE:-/var/log/just-task-it/error.log}
      - LOGGER_UNCAUGHT_EXCEPTION_LOG_FILE=${LOGGER_UNCAUGHT_EXCEPTION_LOG_FILE:-/var/log/just-task-it/uncaught-exception.log}
    ports:
      - "${DOCKER_HOST_PORT}:${EXPRESS_APP_PORT:-3000}"

volumes:
  redis-data:
  rabbitmq-data:
