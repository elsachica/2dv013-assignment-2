services:
  mongodb:
    image: mongo:8.0.0
    healthcheck:
      test: mongosh --eval "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - mongodb-data:/data/db
    ports:
    - "27018:27017" 

  redis:
    image: redis:7-alpine
    healthcheck:
      test: redis-cli ping
      interval: 5s
      timeout: 3s
      retries: 3
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  rabbitmq:
    image: rabbitmq:3-management-alpine
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=admin
      - RABBITMQ_DEFAULT_PASS=password
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq

  just-task-it:
    build:
      context: ./taskit-service
    image: pannkakor/taskit-backend:1.0.0
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: on-failure
    environment:
      - BASE_URL=${BASE_URL:-/}
      - DB_CONNECTION_STRING=${DB_CONNECTION_STRING:-mongodb://mongodb:27017/just-task-it}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - RABBITMQ_URL=${RABBITMQ_URL:-amqp://admin:password@rabbitmq:5672}
      - PORT=${EXPRESS_APP_PORT:-3000}
      - SESSION_NAME=${SESSION_NAME:-just-task-it-feat-logging.user-session}
      - SESSION_SECRET=${SESSION_SECRET}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOGGER_MORGAN_FORMAT_ADD_REMOTE=${LOGGER_MORGAN_FORMAT_ADD_REMOTE:-true}
      - LOGGER_COMBINED_LOG_FILE=${LOGGER_COMBINED_LOG_FILE:-/var/log/just-task-it/combined.log}
      - LOGGER_ERROR_LOG_FILE=${LOGGER_ERROR_LOG_FILE:-/var/log/just-task-it/error.log}
      - LOGGER_UNCAUGHT_EXCEPTION_LOG_FILE=${LOGGER_UNCAUGHT_EXCEPTION_LOG_FILE:-/var/log/just-task-it/uncaught-exception.log}
    ports:
      - "${DOCKER_HOST_PORT}:${EXPRESS_APP_PORT:-3000}"

  analytics:
    build:
      context: ./analytics-service
    image: pannkakor/taskit-analytics:1.0.0
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: on-failure
    environment:
      - PORT=4000
      - ANALYTICS_DB_URL=${ANALYTICS_DB_URL:-mongodb://mongodb:27017}
      - RABBITMQ_URL=${RABBITMQ_URL:-amqp://admin:password@rabbitmq:5672}
    ports:
      - "4000:4000"

volumes:
  mongodb-data:
  redis-data:
  rabbitmq-data:

  
# services:
#   mongodb:
#     image: mongo:8.0.0
#     volumes:
#       - mongodb-data:/data/db

#   redis:
#     image: redis:7-alpine
#     ports:
#       - "6379:6379"
#     volumes:
#       - redis-data:/data

#   rabbitmq:
#     image: rabbitmq:3-management-alpine
#     ports:
#       - "5672:5672"
#       - "15672:15672"
#     environment:
#       - RABBITMQ_DEFAULT_USER=admin
#       - RABBITMQ_DEFAULT_PASS=password
#     volumes:
#       - rabbitmq-data:/var/lib/rabbitmq

#   just-task-it:
#     build:
#       context: ./taskit-service  # ← ÄNDRA HÄR!
#     image: 2dv013/just-task-it:1.0.0
#     depends_on:
#       - mongodb
#       - redis
#       - rabbitmq
#     restart: on-failure
#     environment:
#       - BASE_URL=${BASE_URL:-/}
#       - DB_CONNECTION_STRING=${DB_CONNECTION_STRING:-mongodb://mongodb:27017/just-task-it}
#       - REDIS_URL=${REDIS_URL:-redis://redis:6379}
#       - RABBITMQ_URL=${RABBITMQ_URL:-amqp://admin:password@rabbitmq:5672}
#       - PORT=${EXPRESS_APP_PORT:-3000}
#       - SESSION_NAME=${SESSION_NAME:-just-task-it-feat-logging.user-session}
#       - SESSION_SECRET=${SESSION_SECRET}
#       - LOG_LEVEL=${LOG_LEVEL:-info}
#       - LOGGER_MORGAN_FORMAT_ADD_REMOTE=${LOGGER_MORGAN_FORMAT_ADD_REMOTE:-true}
#       - LOGGER_COMBINED_LOG_FILE=${LOGGER_COMBINED_LOG_FILE:-/var/log/just-task-it/combined.log}
#       - LOGGER_ERROR_LOG_FILE=${LOGGER_ERROR_LOG_FILE:-/var/log/just-task-it/error.log}
#       - LOGGER_UNCAUGHT_EXCEPTION_LOG_FILE=${LOGGER_UNCAUGHT_EXCEPTION_LOG_FILE:-/var/log/just-task-it/uncaught-exception.log}
#     ports:
#       - "${DOCKER_HOST_PORT}:${EXPRESS_APP_PORT:-3000}"

#   analytics:
#     build:
#       context: ./analytics-service  # ← NY SERVICE!
#     image: 2dv013/jti-analytics:1.0.0
#     depends_on:
#       - mongodb
#       - rabbitmq
#     restart: on-failure
#     environment:
#       - PORT=4000
#       - ANALYTICS_DB_URL=${ANALYTICS_DB_URL:-mongodb://mongodb:27017}  # ← ANVÄND .env
#       - RABBITMQ_URL=amqp://admin:password@rabbitmq:5672
#     ports:
#       - "4000:4000"

# volumes:
#   mongodb-data:
#   redis-data:
#   rabbitmq-data: