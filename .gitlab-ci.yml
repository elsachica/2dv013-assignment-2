# Bygger och pushar images med Buildah (fungerar pÃ¥ GitLab Shared Runners) och deployar till Kubernetes

stages:
  - build
  - test
  - deploy

variables:
  IMAGE_BACKEND: docker.io/$DOCKER_USER/taskit-backend:latest
  IMAGE_ANALYTICS: docker.io/$DOCKER_USER/taskit-analytics:latest

# Bygg Taskit-backend med Buildah
build_taskit:
  stage: build
  image: quay.io/buildah/stable:latest
  script:
    - buildah bud -t $IMAGE_BACKEND ./taskit-service
    - echo $DOCKER_PASSWORD | buildah login -u $DOCKER_USER --password-stdin docker.io
    - buildah push $IMAGE_BACKEND

# Bygg Analytics med Buildah
build_analytics:
  stage: build
  image: quay.io/buildah/stable:latest
  script:
    - buildah bud -t $IMAGE_ANALYTICS ./analytics-service
    - echo $DOCKER_PASSWORD | buildah login -u $DOCKER_USER --password-stdin docker.io
    - buildah push $IMAGE_ANALYTICS

# Test Taskit-backend
test_taskit:
  stage: test
  image: node:20
  script:
    - cd taskit-service
    - npm ci
    - npm run lint
    - npm test || echo "No tests yet"

# Test Analytics
test_analytics:
  stage: test
  image: node:20
  script:
    - cd analytics-service
    - npm ci
    - npm run lint || echo "No linter"
    - npm test || echo "No tests yet"

# Deploy till Kubernetes
deploy_k8s:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - echo "$KUBECONFIG_DATA" | base64 -d > kubeconfig.yaml
    - export KUBECONFIG=$PWD/kubeconfig.yaml
    - kubectl apply -f k8s/
  only:
    - main
    - master
  environment:
    name: production